<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        .diffContentTable,
        .allContentTable {
            width: 100vw;
            height: 100vh;
            background: #6666667a;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 0;
            z-index: 2;
        }

        /* .allContentTable{

        } */

        .isHide {
            display: none;
        }

        .contentPart {
            width: 60%;
            background: #fff;
            padding: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .titleContent {
            width: 100%;
            color: #000;
            padding: 4px 0;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .diffTable,
        .allTable {
            width: 100%;
            padding: 4px;
        }

        .allTable>tbody>tr>td {
            text-align: center;
        }

        .selfTable {
            width: 100%;
        }

        .selfTable>tbody>tr,
        .diffTable>tbody>tr {
            text-align: center;
        }

        .selfTable>tbody>tr>td {
            border-bottom: 1px solid #666;
            padding-bottom: 10px;
        }

        .selfTable>tbody>tr>td:first-child,
        .selfTable>tbody>tr>td:last-child,
        .diffTable>tbody>tr>td:first-child,
        .diffTable>tbody>tr>td:last-child {
            width: 10%;
        }

        .selfTable>tbody>tr>td:nth-child(2),
        .selfTable>tbody>tr>td:nth-child(3) {
            width: 40%;
        }

        .selfTable>tbody>tr.sel {
            background: #03a9f4;
        }

        .tablePart {
            padding: 30px 0;
            margin: 20px 0;
            border-top: 1px solid #666;
            border-bottom: 1px solid #666;
        }

        .content {
            margin-left: 10px;
        }

        .contentLong {
            display: none;
        }
    </style>
</head>

<body>
    <div class='diffContentTable isHide'>
        <div class='contentPart'>
            <div class='titleContent'>原内容已被修改</div>
            <table class='diffTable'>
                <thead>
                    <th>序号</th>
                    <th>原划词内容</th>
                    <th>现划词内容</th>
                    <th>原评论内容</th>
                    <th>备注</th>
                    <th>操作</th>
                </thead>
                <!-- <tbody onclick="positionRow(event)"></tbody> -->
                <tbody onclick="hideOne(event)"></tbody>
            </table>
            <button onclick="closeDiffTable()">关闭</button>
        </div>
    </div>

    <div class='allContentTable isHide'>
        <div class='contentPart'>
            <div class='titleContent'>可能包含的划词区域</div>
            <table class='allTable'>
                <thead>
                    <th>序号</th>
                    <th>划词内容</th>
                    <th>评论内容</th>
                    <th>操作</th>
                </thead>
                <tbody onclick="positionRow(event)"></tbody>
                <!-- <tbody></tbody> -->
            </table>
            <button onclick="closeAllTable()">关闭</button>
        </div>
    </div>

    <div class='content'>
        Lorem ipsum dolor sit amet consectetur,Explicabo architecto maxime ratione ipsa asperiores aut, suscipit
        repudiandae ipsum maiores quam recusandae nemo? Laudantium, quod provident? Ratione quis necessitatibus id
        distinctio.
        Et laudantium amet cumque obcaecati. Sit, <br />
        <p>123</p>
        <h1></h1>
        <h2></h2>
        <h3></h3> reiciendis laudantium maiores impedit tempore nisi, saepe autem tenetur cupiditate rerum amet
        excepturi necessitatibus. Distinctio illo autem reprehenderit natus molestiae dolorem molestias iusto adipisci?
        Nostrum nemo</p><br /> officiis ipsam doloribus. Accusantium ipsum placeat doloremque voluptas eligendi quos ea
        praesentium id aut minima quo aliquid quas, necessitatibus dicta soluta alias laborum maxime natus temporibus.
        Eveniet, quia!
        Consequuntur voluptates dignissimos architecto sapiente, <br />
        <p>assumenda vero illo quas. Fugit, doloribus dolore necessitatibus rerum blanditiis dolores iusto, earum
            incidunt ratione quaerat possimus vero delectus quia at exercitationem sapiente nulla enim.
            Iusto explicabo asperiores blanditiis itaque harum dolorem sed animi eligendi, </p><br /> quis cupiditate!
        Vitae sapiente tenetur aspernatur harum hic nobis optio modi mollitia dolorum, error sunt, dolore obcaecati
        laudantium libero et.
        Consequatur maiores adipisci quia voluptate sequi eligendi saepe consectetur facere? Qui suscipit officia eum,
        quidem, aliquid nulla veritatis assumenda rerum iusto debitis veniam illum dolorem quisquam vitae, facere
        dignissimos quaerat.
    </div>
    <div class='contentLong'>
        远上寒山石径斜，<br />白云深处有人家。<br />停车坐爱枫林晚，<br />霜叶红于二月花。
    </div>

    <div class='tablePart'>
        <table class='selfTable'>
            <thead>
                <th>序号</th>
                <th>ID</th>
                <th>划词内容</th>
                <th>评论内容</th>
                <th>操作</th>
            </thead>
            <tbody onclick='rowClickBtn(event)'>
                <!-- <tr>
                    <td>1</td>
                    <td>测试内容</td>
                    <td>测试评论</td>
                    <td>
                        <button data-row = "{'hcnr':'测试内容','plnr':'测试评论','id':'test000'}">
                            删除
                        </button>
                    </td>
                </tr> -->
            </tbody>
        </table>
    </div>
    <div class='btnPart'>
        <button onclick = 'clearTable()'>清空所有表格选择</button>
        <button onclick = 'saveFn()'>
            保存
        </button>
        <button onclick = 'showContentFn()'>
            模拟回显内容
        </button>
        <button onclick = 'editFnOne()'>
            模拟修改内容 1
        </button>
        <button onclick = 'editFnTwo()'>
            模拟修改内容 2
        </button>
    </div>
</body>
<script src="./konva.min.js"></script>
<script src="./_konva.logic.js"></script>
<script src="./jqProTools.js"></script>
<script src="./jqProEntry.js"></script>
<script>
    // 如何使用 (Jquery项目) ******** Start *********************************************************************
    // 按顺序引入相关资源：
    
    // 1. konva.min.js
    // 2. _konva.logic.js
    // 3. yuqueFixedTools.js
    // 4. yuqueFixedText.js


    // 划词后生成的评论按钮样式
    // 格式：css 属性 ：css 属性值
    let btnStyle = {
        width: "50px",
        height: '30px',
        fontSize: "14px",
        letterSpacing: "1px",
        background: "#29a2ff",
        border: '1px solid #29a2ff',
        color: '#fff',
        textAlign: "center",
        lineHeight: '30px',
        cursor: 'pointer'
    };

    /**
     * 当前demo中我使用的是js触发原生 prompt 框，当然你可以使用你项目中 UI 框架中的提示输入框的事件
     * 但请注意：需要将传入的事件包装为一个 Promise
     * resolve 为 用户填入的评论内容
     * reject 为 用户取消评论后想做的任何事（比如：弹出提示...） 
     */

    let selfPromptFn = function () {
        return new Promise((resolve, reject) => {
            let plJs = prompt('评论内容：')
            if (plJs != null) {
                // let successFn = function(){
                //     return plJs;
                // };

                resolve(plJs);
            }
            else {
                let cancalFn = function () {
                    alert('取消评论！')
                    // return null;
                };

                reject(cancalFn);
            }
        })
    }

    /**
     * 将格式化后的数据插入至表格中，我这里是原生JS直接插入表格中,当然你也可以传给后台，或者可以随意处理这些格式化后的数据
     * @param resData --- 格式化后的数据（插件返回）
     */
    let addTableDataFn = function (resData) {

        let _tableDom = document.querySelector('.selfTable > tbody');
        let nowTrLength = _tableDom.children.length;

        let newTr = document.createElement('tr');
        newTr.innerHTML = `<tr data-row = '${JSON.stringify(resData)}'>
                        <td data-row = '${JSON.stringify(resData)}'>${nowTrLength + 1}</td>
                        <td data-row = '${JSON.stringify(resData)}'>${resData.id}</td>
                        <td data-row = '${JSON.stringify(resData)}'>${resData.hcnr}</td>
                        <td data-row = '${JSON.stringify(resData)}'>${resData.plnr}</td>
                        <td data-row = '${JSON.stringify(resData)}'>
                            <button data-sel = '${JSON.stringify(resData)}'>
                                删除
                            </button>
                        </td>
                    </tr>
                    `

        _tableDom.appendChild(newTr);
    }

    /**
    * 高亮划词区域对应的表格行......
    * 将点击文章中的任意一个Range划词区域，回调参数是 Range 的Id
    * 遍历当前表格，找到符合点击区域的ID，高亮表格行，我这里使用的是原生JS高亮表格行,当然你可以使用你项目中用的ui组件里的方法
    */
    let tableRowClickCallback = function (rangeId) {
        for (let item of document.querySelector('.selfTable > tbody').children) {
            let thisRowRangeId = '';
            if (item.children[0].dataset.row) {
                thisRowRangeId = JSON.parse(item.children[0].dataset.row).id;
            }

            if (thisRowRangeId == rangeId) {
                item.classList.add('sel');
            }
            else {
                item.classList.remove('sel');
            }
        }
    }

    /**
     * 当前内容与上次的不符的处理函数（参数为具体内容）
     *  内容为：
     *          blankFold:xxx ---- 之前文章的空白折叠
                sPos:xxx ---- 当前划词内容在之前文章中的第几个字开始
                ePos:xxx ---- 当前划词内容在之前文章中的第几个字结束
                hcnr:xxx ---- 之前的划词内容
                nowHcnr:xxxx ---- 现在的划词内容
                plnr:xxx ---- 之前的划词内容的评论
                id:xxxx ---- 划词区域 ID

     * 当前 DEMO 中，我的处理是：绘制一个表格，将原内容，当前内容，原评论，备注（原内容已被修改），
       并在每一行后面有个隐藏按钮，点击后此内容在内容区域中所对应的划词区域中的下划线隐藏

     * 当然你可以在你的项目中任意使用这些数据
    */

    let showDiffContentFn = function (resData) {
        document.querySelector('.diffContentTable').classList.remove('isHide');

        let _tableDom = document.querySelector('.diffTable > tbody');
        _tableDom.innerHTML = '';
        let nowTrLength = _tableDom.children.length;

        let newTr = document.createElement('tr');

        newTr.innerHTML = `<tr>
                        <td>${nowTrLength + 1}</td>
                        <td>${resData.hcnr}</td>
                        <td>${resData.nowHcnr}</td>
                        <td>${resData.plnr}</td>
                        <td>原内容已被修改</td>
                        <td>
                            <button data-row = '${JSON.stringify(resData)}'>
                                隐藏
                            </button>
                        </td>
                        </tr>
                        `

        _tableDom.appendChild(newTr);

    };


    /**
     * 所有区域的相关信息的相关处理函数（参数为具体内容）
     *  内容为：[
     *            {
     *              blankFold:xxx ---- 之前文章的空白折叠
                    sPos:xxx ---- 当前划词内容在之前文章中的第几个字开始
                    ePos:xxx ---- 当前划词内容在之前文章中的第几个字结束
                    hcnr:xxx ---- 之前的划词内容
                    nowHcnr:xxxx ---- 现在的划词内容
                    plnr:xxx ---- 之前的划词内容的评论
                    isDiff:xxx --- 之前划词内容是否已经被修改（之前划词开始位置和结束位置之间的内容和现在内容是否一致）
                    id:xxxx ---- 划词区域 ID
     *            },
                    ...
     *          ]

     * 当前 DEMO 中，我的处理是：绘制一个表格，将原内容（如果 isDiff 是 true，则后面加上  原内容已被修改），原评论，
       并在每一行后面有个查看详情按钮和定位按钮

       点击查看详情：打开内容已被修改的表格并显示
       点击定位：当前划词区域会高亮且文章下面的表格对应行会被高亮选中......

     * 当然你可以在你的项目中任意使用这些数据
    */

    let showAllContentFn = function (resData) {
        document.querySelector('.allContentTable').classList.remove('isHide');

        let _tableDom = document.querySelector('.allTable > tbody');
        _tableDom.innerHTML = '';

        let frag = document.createDocumentFragment();

        for (let i = 0; i < resData.length; i++) {
            let item = resData[i];
            // 排除内容项为null的情况......
            if (item == null) {
                continue;
            }
            let newTr = document.createElement('tr');
            newTr.innerHTML = `<tr>
                                <td>${i + 1}</td>
                                <td>${item.hcnr}${item.isDiff ? '（原内容已被修改）' : ''}</td>
                                <td>${item.plnr}</td>
                                <td>
                                    <button data-row = '${JSON.stringify(item)}'>
                                        
                                        ${item.isDiff ? '查看详情' : '定位'}
                                    </button>
                                </td>
                            </tr>
                            `

            frag.appendChild(newTr);
        }



        _tableDom.appendChild(frag);

    };

    /**
     * 创建实例 UnderlineComments
     * 
     * @param {string} 参数一：内容区域DOM选择器
     ************************************************************
     * @param {Object} 参数二：划词后生成的评论按钮样式(格式：css 属性 ：css 属性值)
     ************************************************************
     * @param {Function} 参数三：划词后点击评论按钮触发的事件（请包装为一个 Promise 返回，resolve的值为评论内容，reject 的值为用户取消评论后做的事的回调函数） 
     ************************************************************
     * @param {Function} 参数四：用户单次操作后（划词完输入完评论内容后）要做的事（如：将数据显示在页面的一个已经创建好的表格或者任意ui组件里），插件会返回用户评论完后的数据（当前单次的划词内容，评论内容，ID）
     ************************************************************
     * @param {Function} 参数五：点击表格（或其他 ui组件）中单条数据的回调函数(点击的单条数据对应的划词区域id会通过参数返回)，如果不需要则传 null 就好；
                       （如：在表格UI组件中，点击单行表格数据高亮此行，这个参数的函数还会使得用户点击划词区域时触发对应表格行高亮；
                            如果你使用的是其他UI组件的话，需要将回调函数里面的内容换成你自己的业务逻辑）
     ************************************************************
     * @param {Function} 参数六：因为后台存的每条数据是相对于整篇文章的偏移量（也就是单条评论是文章中的第几个字开始到第几个字结束）
                                所以如果同样位置下划词区域的内容与上次保存的内容不一致的话（如：文章内容在上一次保存后被修改），会触发这个函数，参数是插件返回的对应的单条数据具体内容
     ************************************************************
     * @param {Function} 参数七：获取当前所有区域下的数据（包含同样位置下划词区域的内容与上次保存的内容不一致的项）
    */

    let thisSelTool = new UnderlineComments('.content', btnStyle, selfPromptFn, addTableDataFn, tableRowClickCallback, showDiffContentFn, showAllContentFn);
    // 初始化实例 UnderlineComments
    thisSelTool.init();

    // 如何使用 (Jquery项目) ******** End *********************************************************************


    // ********************* 当前 DEMO 中涉及到的函数 *********************

    /**
     * 表格行点击事件，在Demo中为每一行生成了一个删除按钮，为 每一行的父元素 tbody 注册了点击事件，通过点击的元素的自定义属性是 data-sel 的话，说明点击的是删除按钮,需要删除当前行且移除内容区域的划词区域
     * 反之为非删除按钮的其他元素，那只需要高亮显示当前行即可...
     */
    function rowClickBtn() {
        let e = arguments[0];
        if (e.target.dataset.sel) {// 点击了删除按钮...
            let resultId = JSON.parse(e.target.dataset.sel).id;
            thisSelTool.delOnceRange(resultId);

            e.target.parentNode.parentNode.remove();

            // 对表格序号进行重排...
            let _tableDom = document.querySelector('.selfTable > tbody');
            let nowTrLength = _tableDom.children.length;
            for(let i = 0;i < nowTrLength;i++){
                document.querySelector(`.selfTable > tbody > tr:nth-child(${i + 1}) > td:first-child`).innerText = i + 1;
            }
           
        }
        else if (e.target.dataset.row) {// 点击了非删除按钮的其他元素...
            for (let item of document.querySelector('.selfTable > tbody').children) {
                item.classList.remove('sel');
            };

            e.target.parentNode.classList.add('sel');
            let resultId = JSON.parse(e.target.dataset.row).id;
            _chooseRectById(resultId, thisSelTool._layerGlobal);// 点击高亮当前区域
        }

        // console.log(thisSelTool._stageGlobal);
    }

    /**
     * 关闭内容不一致情况的表格
     */
    function closeDiffTable() {
        document.querySelector('.diffContentTable').classList.add('isHide');
    }

    /**
     * 关闭同一区域下可能存在多条内容的表格
     */
    function closeAllTable() {
        document.querySelector('.allContentTable').classList.add('isHide');
    }

    /**
     * 点击同一区域下可能存在多条内容的表格时，定位到某一行
     */
    function positionRow(event) {
        if (event.target.dataset.row) {
            let itemData = event.target.dataset.row;
            let resultId = JSON.parse(itemData).id;
            let isDiff = JSON.parse(itemData).isDiff;

            if (!isDiff) {
                _chooseRectById(resultId, thisSelTool._layerGlobal);// 点击高亮当前区域
                // thisSelTool.tableRowClickCallback(JSON.parse(itemData));
                tableRowClickCallback(resultId);
            }
            else {
                showDiffContentFn(JSON.parse(itemData));
            }
        }
        document.querySelector('.allContentTable').classList.add('isHide');
    }

    /**
     * 因为表格中会存在同样位置下划词区域的内容与上次保存的内容不一致的情况
     * 因为会存在文章被修改的情况，那么有些划词区域的内容与上次保存的内容就会不一致，那么这些内容的下面会出现和正确内容不一样颜色的下划线，如果需要隐藏这些下划线的话，可以使用
       yuqueFixedTools.js 中的 _hideRectAndLineById 方法将其下划线（传入当前区域的ID 和 layer图层）隐藏
     */

    function hideOne(event) {
        if (event.target.dataset.row) {
            let itemData = event.target.dataset.row;
            let resultId = JSON.parse(itemData).id;
            // let isDiff = JSON.parse(itemData).isDiff;

            _hideRectAndLineById(resultId, thisSelTool._layerGlobal);
        }
    }


    /**
     * 保存当前已划词区域的数据（通过 thisSelTool.rectPosList）
     */
    function saveFn() {
        console.log('249', thisSelTool.rectPosList);
    };

    /**
     * 清空表格高亮
     */
    function clearTable() {
        cleanAllRectOrLine(thisSelTool._layerGlobal);
        if(thisSelTool.tableRowClickCallback != null){
            thisSelTool.tableRowClickCallback("clear");
        }
    };

    /**
     * 模拟后台存储的数据
    */
    let saveData = [
        {
            blankFold: 9,
            ePos: 75,
            hcnr: "Lorem ipsum dolor sit amet consectetur,Explicabo architecto maxime",
            id: "58688ADF",
            plnr: "222",
            sPos: 9
        },
        {
            blankFold:9,
            ePos:481,
            hcnr:"reiciendis laudantium maiores impedit tempore nisi, saepe autem tenetur cupiditate rerum amet\n        excepturi necessitatibus. Distinctio ill",
            id:"6A819DB4",
            plnr:"123",
            sPos:339
        },
        {
            blankFold:9,
            ePos:1159,
            hcnr:"umenda vero illo quas. Fugit, doloribus dolore necessitatibus rerum blanditiis dolores iusto, earum\n            incidunt ratione quaerat possimus vero delectus quia at exercitationem sapiente nulla enim.\n            Iusto explicabo asperiores blanditiis itaque harum dolorem se",
            id:"B19145D6",
            plnr:"321",
            sPos:882
        }
    ];

    /**
     * 上显数据
    */
    function showContentFn() {
        thisSelTool.showOldData(saveData);
    }


    function editFnOne() {
        let content = document.querySelector('.content');

        content.innerHTML = `Lorem ipsum dolor sit amet consectetur, 需要删除的文字. Explicabo architecto maxime ratione ipsa asperiores aut, suscipit repudiandae ipsum maiores quam recusandae nemo? Laudantium, quod provident? Ratione quis necessitatibus id distinctio.
        Et laudantium amet cumque obcaecati. Sit, <br/><p>123</p> <h1></h1><h2></h2><h3></h3> reiciendis laudantium maiores impedit tempore nisi, saepe autem tenetur cupiditate rerum amet excepturi necessitatibus. Distinctio illo autem reprehenderit natus molestiae dolorem molestias iusto adipisci?
        Nostrum nemo</p><br/> officiis ipsam doloribus. Accusantium ipsum placeat doloremque voluptas eligendi quos ea praesentium id aut minima quo aliquid quas, necessitatibus dicta soluta alias laborum maxime natus temporibus. Eveniet, quia!
        Consequuntur voluptates dignissimos architecto sapiente, <br/> <p>assumenda vero illo quas. Fugit, doloribus dolore necessitatibus rerum blanditiis dolores iusto, earum incidunt ratione quaerat possimus vero delectus quia at exercitationem sapiente nulla enim.
        Iusto explicabo asperiores blanditiis itaque harum dolorem sed animi eligendi, </p><br/> quis cupiditate! Vitae sapiente tenetur aspernatur harum hic nobis optio modi mollitia dolorum, error sunt, dolore obcaecati laudantium libero et.
        Consequatur maiores adipisci quia voluptate sequi eligendi saepe consectetur facere? Qui suscipit officia eum, quidem, aliquid nulla veritatis assumenda rerum iusto debitis veniam illum dolorem quisquam vitae, facere dignissimos quaerat.`;
    }


    function editFnTwo() {
        let content = document.querySelector('.content');

        content.innerHTML = `京口`;
    }
</script>

</html>